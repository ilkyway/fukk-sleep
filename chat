import asyncio

from pywebio import start_server

from pywebio.input import *

from pywebio.output import *

from pywebio.session import defer_call, info as session_info, run_async, run_js

chat_msgs = []

online_users = set()

MAX_MESSAGES_COUNT = 100

async def main():

    global chat_msgs

    

    put_markdown("##  –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ–Ω–ª–∞–π–Ω —á–∞—Ç Fukk Sleep!")

    msg_box = output()

    put_scrollable(msg_box, height=300, keep_bottom=True)

    nickname = await input("–í–æ–π—Ç–∏ –≤ —á–∞—Ç", required=True, placeholder="–í–∞—à –Ω–∏–∫", validate=lambda n: "–¢–∞–∫–æ–π –Ω–∏–∫ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è!" if n in online_users or n == 'üì¢' else None)

    online_users.add(nickname)

    chat_msgs.append(('üì¢', f'`{nickname}` –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É!'))

    msg_box.append(put_markdown(f'üì¢ `{nickname}` –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É'))

    refresh_task = run_async(refresh_msg(–ø—Å–µ–≤–¥–æ–Ω—ñ–º, msg_box))

    –ø–æ–∫–∏ –ø—Ä–∞–≤–¥–∞:

        data = await input_group("üí≠ –ù–æ–≤–æ–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è", [

            input(placeholder="–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è ...", name="msg"),

            actions(name="cmd", buttons=["–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏", {'label': "–í–∏–π—Ç–∏ –∑ —á–∞—Ç–∞", 'type': 'cancel'}])

        ], validate = lambda m: ('msg', "–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!"), —è–∫—â–æ m["cmd"] == "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏", –∞ –Ω–µ m['msg'] else –ù–µ–º–∞—î)

        —è–∫—â–æ –¥–∞–Ω–∏—Ö –Ω–µ–º–∞—î:

            –ø–µ—Ä–µ—Ä–≤—É

        msg_box.append(put_markdown(f"`{nickname}`: {data['msg']}"))

        chat_msgs.append((–ø—Å–µ–≤–¥–æ–Ω—ñ–º, –¥–∞–Ω—ñ['msg']))

    refresh_task.close()

    online_users.remove(–ø—Å–µ–≤–¥–æ–Ω—ñ–º)

    toast("–í–∏ –≤–∏–π—à–ª–∏ –∑ —á–∞—Ç–∞!")

    msg_box.append(put_markdown(f'üì¢ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á `{nickname}` –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç!'))

    chat_msgs.append(('üì¢', f'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `{nickname}` –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç!'))

    put_buttons(['–ü–µ—Ä–µ–∑–∞–π—Ç–∏'], onclick=lambda btn:run_js('window.location.reload()'))

async def refresh_msg(–ø—Å–µ–≤–¥–æ–Ω—ñ–º, msg_box):

    –≥–ª–æ–±–∞–ª—å–Ω–∏–π chat_msgs

    last_idx = len(chat_msgs)

    –ø–æ–∫–∏ –ø—Ä–∞–≤–¥–∞:

        –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è asyncio.sleep(1)

        

        –¥–ª—è m —É chat_msgs[last_idx:]:

            if m[0] != –ø—Å–µ–≤–¥–æ–Ω—ñ–º: # —è–∫—â–æ –Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

                msg_box.append(put_markdown(f"`{m[0]}`: {m[1]}"))

        

        –¢–µ—Ä–º—ñ–Ω –¥—ñ—ó # –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è

        —è–∫—â–æ len(chat_msgs) > MAX_MESSAGES_COUNT:

            chat_msgs = chat_msgs[len(chat_msgs) // 2:]

        

        last_idx = len(chat_msgs)

—è–∫—â–æ __name__ == "__main__":

    start_server(main, debug=True, port=1111, cdn=False)
